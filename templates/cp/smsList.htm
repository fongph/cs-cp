<style>
    .popover {
        position: relative;
        display: block;
        margin: 15px 0;
        max-width: 100%;
        width: 85%;
    }

    .popover.left {
        float: right;
        right: 10px;
        left: auto;
    }

    .messages-list {
        border: 1px solid #e1e1e8;
        background-color: #f7f7f9;
        padding: 10px 2px;
    }

    .messages-list > div {
        overflow: hidden;
    }

    .date-title {
        font-size: 20px;
        text-align: center;
        border-bottom: 1px solid #ccc;
        padding: 5px 0;
        margin: 5px 0;
    }
    
    .panel-top {
        margin-bottom: 10px;
        vertical-align: bottom;
    }
</style>
<div>
    <h1 class="text-center">{$title}</h1>

    {insert "inc.flashMessages.htm"}

    <div class="panel-top">
        <p class="text-info">Messages with <b>{if strlen($userName)}{$userName}{else}{$userPhone}{/if}</b></p>
        <a class="btn btn-default" href="{$di.router->getRouteUrl('sms')}">Back to SMS log</a>
    </div>

    <div class="messages-list">
        {foreach $list as $item}
        <div id="{$item.timestamp}">
            <div class="popover {if $item.type == 'in'}right{else}left{/if}{if $item.blocked > 0} text-danger{/if}">
                <div class="arrow"></div>
                
                <h3 class="popover-title{if $item.type == 'in'} in{else} out{/if}">
                    {if $item.type == 'in'}
                    <b>{if strlen($item.name)}{$item.name}{else}{$item.phone}{/if}</b> <span class="date"></span>
                    {else}
                    <span class="date"></span>
                    {/if}
                    
                    {if $item.deleted}
                        <span class="label label-danger" style="float: right;">Deleted</span>
                    {/if}
                </h3>
                
                <div class="popover-content">
                    <p>{$item.content}</p>
                </div>
            </div>
        </div>
        {/foreach}
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function() {
        moment.lang('{$di.t->getLocale()}');

        var last = 0;
        $('.messages-list > div').each(function() {
            var timestamp = $(this).attr('id');

            var date = moment.unix(timestamp).zone(0).format("LL");
            if (date !== last) {
                $(this).before('<div class="date-title">' + date + '</div>');
            }

            var date = moment.unix(timestamp).zone(0).format("LLL");
            $(this).find('.popover-title span.date').html(date);

            last = moment.unix(timestamp).zone(0).format("LL");
        });
    });
</script>