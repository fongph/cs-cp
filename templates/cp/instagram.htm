<style type="text/css">
    .item {
        display: inline-block;
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 5px 5px 0;
    }

    .item img {
        width: 150px;
        height: 150px;
        z-index: 10;
        border-radius: 5px;
    }

    .item .comments {
        position: absolute;
        bottom: 0px;
        right: 0px;
        z-index: 20;
        background: #000;
        padding: 4px;
        border-radius: 5px 0px 5px 0px;
        opacity: 0.7;
    }

    .item .date {
        position: absolute;
        top: 0px;
        left: 0px;
        z-index: 20;
        background: #000;
        padding: 4px;
        font-size: 10px;
        color: #fff;
        border-radius: 5px 0px 5px 0px;
        opacity: 0.7;
    }
</style>
<div>
    <h1 class="text-center">{$title}</h1>

    {insert "inc.flashMessages.htm"}

    {if !$paid}
    {insert "cp/updatePackage.html"}
    {elseif 1}
    <div class="row form-inline">
        <div class="col-lg-6 col-md-6 col-sm-6">
            <label for="account">{$di.t->_('Account')} </label>
            {include "scripts/select.htm" name="account" id="account" class="form-control" options=$accounts}
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6">
            <div class="daterangepickerWrapper">
                <div id="reportrange" class="btn btn-default pull-right">
                    <i class="fa fa-calendar fa-lg"></i>
                    <span></span>
                    <b class="caret"></b>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-pills" style="margin: 10px 0;">
        <li class="active"><a href="#messages" data-toggle="tab">{$di.t->_('Posted photos')}</a></li>
        <li><a href="#calls" data-toggle="tab">{$di.t->_('Friends\' photos')}</a></li>
        <li><a href="#calls1" data-toggle="tab">{$di.t->_('Posted comment')}</a></li>
    </ul>

    <div class="panel panel-default">
        <div class="panel-body text-center" id="contentData">
            <a href="" class="item">
                <div class="date"></div>
                <img src="http://scontent-b.cdninstagram.com/hphotos-xpa1/t51.2885-15/s306x306/e15/10723771_705821956167485_1541973781_n.jpg" alt="" />
                <div class="comments">
                    <i class="fa fa-comment"></i> 1
                </div>
            </a>
            <a href="" class="item">
                <div class="date"></div>
                <img src="http://scontent-b.cdninstagram.com/hphotos-xaf1/t51.2885-15/s306x306/e15/10948179_351659248370801_270298003_n.jpg" alt="" />
                <div class="comments">
                    <i class="fa fa-comment"></i> 2
                </div>
            </a>
            <a href="" class="item">
                <div class="date"></div>
                <img src="http://scontent-a.cdninstagram.com/hphotos-xfa1/t51.2885-15/s306x306/e15/10895087_768420956586142_1315968546_n.jpg" alt="" />
                <div class="comments">
                    <i class="fa fa-comment"></i> 6
                </div>
            </a>
            <a href="" class="item">
                <div class="date"></div>
                <img src="http://scontent-a.cdninstagram.com/hphotos-xfa1/t51.2885-15/s306x306/e15/10895087_768420956586142_1315968546_n.jpg" alt="" />
                <div class="comments">
                    <i class="fa fa-comment"></i> 6
                </div>
            </a>
            <a href="" class="item">
                <div class="date"></div>
                <img src="http://scontent-a.cdninstagram.com/hphotos-xfa1/t51.2885-15/s306x306/e15/10895087_768420956586142_1315968546_n.jpg" alt="" />
                <div class="comments">
                    <i class="fa fa-comment"></i> 6
                </div>
            </a>
            <a href="" class="item">
                <div class="date"></div>
                <img src="http://scontent-a.cdninstagram.com/hphotos-xfa1/t51.2885-15/s306x306/e15/10895087_768420956586142_1315968546_n.jpg" alt="" />
                <div class="comments">
                    <i class="fa fa-comment"></i> 6
                </div>
            </a>
        </div>
        <div style="border-top: 1px solid #eee; overflow: auto; padding: 8px 0;">
            <div class="col-xs-7" id="statusText"></div>
            <div class="col-xs-5 text-right">
                <div class="btn-group">
                    <a class="btn btn-default disabled" id="paginator-prev"><i class="fa fa-arrow-left"></i></a>
                    <a class="btn btn-default disabled" id="paginator-next"><i class="fa fa-arrow-right"></i></a>
                </div>
            </div>
        </div>
    </div>
    {else}
    <h3>{$di.t->_('Waiting for photos... Why can the data be unavailable?')}</h3>
    {include "content/{$di.t->getLocale()}/noData.html"}
    {/if}
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var instagram = {
            selectRanges: {
                "{$di.t->_('Today')}": [moment().startOf('day'), moment().endOf('day')],
                "{$di.t->_('Yesterday')}": [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],
                "{$di.t->_('Last 7 Days')}": [moment().subtract('days', 6).startOf('day'), moment().endOf('day')],
                "{$di.t->_('Last 30 Days')}": [moment().subtract('days', 29).startOf('day'), moment().endOf('day')],
                "{$di.t->_('This Month')}": [moment().startOf('month'), moment().endOf('month')],
                "{$di.t->_('Last Month')}": [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
            },
            noData: 'No data found!',
            loading: 'Loading...',
            statusText: _.template('Showing <%= from %> to <%= to %> of <%= total %> entries'),
            postTemplate: _.template('<a href="" class="item"><div class="date"><%= date %><% if (isVideo) { %> video<% } %></div><img src="<%= image %>" alt=""><div class="comments"><i class="fa fa-comment"></i> <%= comments %></div></a>'),
            startDate: moment().subtract('days', 29).startOf('day'),
            endDate: moment().endOf('day'),
            page: 1,
            last: null,
            initRangePicker: function () {
                $('#reportrange').daterangepicker({
                    ranges: this.selectRanges,
                    startDate: this.startDate,
                    endDate: this.endDate,
                    format: 'LL',
                    locale: {
                        applyLabel: "{$di.t->_('Apply')}",
                        cancelLabel: "{$di.t->_('Cancel')}",
                        fromLabel: "{$di.t->_('From')}",
                        toLabel: "{$di.t->_('To')}",
                        customRangeLabel: "{$di.t->_('Custom Range')}",
                        daysOfWeek: moment.langData()._weekdaysMin.slice(),
                        monthNames: (function () {
                            var res = [];
                            for (var i = 0; i < 12; i++) {
                                res.push(moment([0, i]).format('MMM'));
                            }
                            return res;
                        })(),
                        firstDay: moment.langData()._week.dow
                    }
                }, function (from, to) {
                    instagram.page = 1;
                    instagram.updateRange(from, to);
                });
            },
            showPosts: function (data) {
                $('#contentData').empty();

                if (data.data.length > 0) {
                    $.each(data.data, function () {
                        $('#contentData').append(instagram.postTemplate({
                            date: moment(this.timestamp * 1000).zone(0).format('lll'),
                            image: this.thumbnail,
                            comments: this.comments,
                            isVideo: this.type === 'video'
                        }));
                    });
                } else {
                    $('#contentData').html('No data found!');
                }

                this.setStatusText(data.page, data.records, data.recordsPerPage, data.data.length);
                this.updatePaginator(this.page, data.records, data.recordsPerPage);
            },
            setStatusText: function (page, records, recordsPerPage, recordsOnPage) {
                if (records > 0) {
                    var from = (parseInt(page, 10) - 1) * recordsPerPage + 1;
                    var to = from + recordsOnPage - 1;

                    $('#statusText').html(this.statusText({
                        from: from,
                        to: to,
                        total: records
                    }));
                } else {
                    $('#statusText').html('');
                }
            },
            updatePaginator: function (page, records, recordsPerPage) {
                var pages = Math.max(Math.ceil(records / recordsPerPage), 1);

                if (page <= 1) {
                    $('#paginator-prev').addClass('disabled');
                } else {
                    $('#paginator-prev').removeClass('disabled');
                }

                if (page < pages) {
                    $('#paginator-next').removeClass('disabled');
                } else {
                    $('#paginator-next').addClass('disabled');
                }
            },
            updateRange: function (start, end) {
                if (start && end && start.isValid() && end.isValid()) {
                    $('#reportrange span').html(start.format('LL') + ' - ' + end.format('LL'));

                    _.find(this.selectRanges, function (period, name) {
                        if ((moment(period[0]).format('l') === start.format('l')) && (moment(period[0]).format('l') === start.format('l'))) {
                            $('#reportrange span').html(name);
                            return true;
                        }
                        return false;
                    });

                    this.last = {
                        start: start,
                        end: end
                    };

                    $('#contentData').html(this.loading);

                    $.post('{$di.router->getRouteUrl("instagram")}', {
                        account: $('#account').val(),
                        dateFrom: moment(start).unix(),
                        dateTo: moment(end).unix(),
                        page: instagram.page
                    }, function (data) {
                        instagram.showPosts(data);
                    }, 'json');
                } else {
                    return this.updateRange(this.startDate, this.endDate);
                }
            },
            update: function () {
                if (this.last !== null) {
                    this.updateRange(this.last.start, this.last.end);
                } else {
                    this.updateRange();
                }
            },
            init: function () {
                this.initRangePicker();
                this.updateRange();

                $('#paginator-prev').click(function () {
                    instagram.page--;
                    instagram.update();
                });

                $('#paginator-next').click(function () {
                    instagram.page++;
                    instagram.update();
                });

                $('#account').change(function () {
                    instagram.page = 1;
                    instagram.update();
                });
            }
        };

        instagram.init();
    });
</script>
